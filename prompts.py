from typing import Dict, Optional


class UnknownPromptModeError(Exception):
    """Бросаем, если mode неизвестен."""
    pass


PROMPT_TEMPLATES: Dict[str, str] = {
    "base": (
        """
        Обнови дизайн экстерьера этого дома.
        Не меняй архитектуру здания, геометрию стен и окон.
        Твоя задача — сделать профессиональный редизайн фасада.
        Используй современные материалы высокого качества.
        Сохрани реалистичность и естественное освещение.
        Фотореализм, 8k.
        """
    ),
    "cinema": (
        """
        Преврати это фото дома в кадр из высокобюджетного кинофильма.
        ВАЖНО: Сохрани масштаб частного жилого дома. НЕ превращай его в небоскреб или огромное здание.
        Сохрани силуэт и основные формы дома, но сделай полный стилистический редизайн фасада.
        Ты ДОЛЖЕН изменить окружение: создай атмосферный ландшафт (сад, лес, улица), подходящий под стиль фильма.
        Добавь кинематографичные детали: особое освещение (золотой час, туман, неон), декор.
        Роскошно, атмосферно, уровень голливудского кино.
        """
    ),
    "light": (
        """
        Трансформируй экстерьер дома, используя светлую и воздушную палитру.
        Не меняй архитектуру здания, геометрию стен и окон.
        Используй оттенки: белый, кремовый, жемчужный, светлое дерево, светлый камень.
        Дом должен выглядеть свежим, приветливым и легким.
        Окружение: солнечный день, яркое естественное освещение.
        Высокое качество, детальная проработка текстур.
        """
    ),
    "dark": (
        """
        Трансформируй экстерьер дома, используя темную и благородную палитру.
        Не меняй архитектуру здания, геометрию стен и окон.
        Используй оттенки: антрацит, черный, графит, темное дерево, обожженный кирпич.
        Дом должен выглядеть стильно, строго и дорого.
        Освещение: контрастное, подчеркивающее текстуры.
        Премиальный современный вид.
        """
    ),
}


def build_prompt(mode: str, extra_text: Optional[str] = None) -> str:
    """
    Собирает финальный промт по ключу mode и доп. тексту.
    Используется в generate_image_from_url.
    """
    try:
        base_prompt = PROMPT_TEMPLATES[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим промта: {mode}") from exc

    if extra_text:
        extra_text = extra_text.strip()
        if extra_text:
            base_prompt = base_prompt.rstrip() + "\n\n" + extra_text

    return base_prompt

response_json_example = """
СТРОГО верни JSON-массив такого вида:
[
{
    "message": "Краткое приветствие и описание настроения (на русском).",
    "palettes": [
     {
        "name": "Название стиля (короткое)",
        "description": "Стены: [Материал/Цвет]. Кровля: [Цвет]. Цоколь: [Материал/Цвет]. Детали: [Цвета]. Общее впечатление."
     },
     ...
    ]
},
]
"""

EXTRA_PROMPT_MODE_DESCRIPTIONS: Dict[str, str] = {
    "cinema": (
        f"""
        Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
        Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
        
        Описание режима:
        Кинематографичный режим (Cinematic). Атмосфера художественного кадра, выразительного света, глубинного объёма, кинотекстур и настроений из известных фильмов.
        Подходят эстетики: Гэтсби, Сумерки, Киберпанк, Хоббит, нуар, ретро-фильм, тёплая кинодрама, высококонтрастное кино, мягкая туманная эстетика.
        ТВОЯ ЗАДАЧА:
        Сгенерировать 6 вариантов JSON-объектов.
        
        {response_json_example}
        ОГРАНИЧЕНИЯ:
        — Никакого текста вне JSON.
        — Никаких комментариев, пояснений, форматирования вне структуры.
        — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Cinematic.
        — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
    "light": (
        f"""
        Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
        Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
        
        Описание режима:
        Светлый режим (Light). Атмосфера чистоты, воздуха и мягкого естественного света.
        Подходят стили: Скандинавский, Прованс, Coastal, Nordic Minimal, Japandi, Modern Farmhouse, Light Rustic, Mediterranean Light, Eco-modern.
        Характерные черты: светлые фасады, природные материалы, мягкие тени, пастельные тона, спокойное окружение, ощущение простора и свежести.
        
        ТВОЯ ЗАДАЧА:
        Сгенерировать 6 вариантов JSON-объектов.
        
        {response_json_example}
        
        ОГРАНИЧЕНИЯ:
        — Никакого текста вне JSON.
        — Никаких комментариев, пояснений, форматирования вне структуры.
        — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Light.
        — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
    "dark": (
        f"""
        Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
        Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
        
        Описание режима:
        Тёмный режим. Строгие, контрастные и архитектурно-графичные визуальные решения.
        Подходят стили: Барнхаус, Индастриал, Modern Black, Contemporary Dark, Japandi Dark, Minimal Brutal, Nordic Noir, Urban Loft Exterior.
        Характерные черты: насыщённые тёмные фасады, резкий или направленный свет, глубокие тени, минимализм в деталях, брутальность материалов, выразительные контрасты и графичность линий.
        
        ТВОЯ ЗАДАЧА:
        Сгенерировать 6 вариантов JSON-объектов.
        
        {response_json_example}
        
        ОГРАНИЧЕНИЯ:
        — Никакого текста вне JSON.
        — Никаких комментариев, пояснений, форматирования вне структуры.
        — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Dark.
        — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
}


def build_extra_prompts_prompt(mode: str) -> str:
    """
    Строит МЕТА-промт для Gemini, который должен сгенерировать 3 коротких доп. текста
    к основному промту генерации изображения, в зависимости от режима.
    """
    try:
        meta_prompt = EXTRA_PROMPT_MODE_DESCRIPTIONS[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим доп. промтов: {mode}") from exc
    return meta_prompt
