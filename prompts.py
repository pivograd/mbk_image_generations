from typing import Dict, Optional


class UnknownPromptModeError(Exception):
    """Бросаем, если mode неизвестен."""
    pass


PROMPT_TEMPLATES: Dict[str, str] = {
    "base": (
        "Преврати это фото дома в качественную визуализацию фасада.\n"
        "Сохрани масштаб частного жилого дома и основные формы.\n"
        "Можно слегка улучшить материалы и окружение, но без радикальных изменений архитектуры."
    ),
    "cinema": (
        "Преврати это фото дома в кадр из высокобюджетного кинофильма.\n"
        "ВАЖНО: Сохрани масштаб частного жилого дома, не превращай его в небоскрёб.\n"
        "Сохрани силуэт и основные формы дома, но сделай стилистический редизайн фасада.\n"
        "Обязательно измени окружение: атмосферный ландшафт (сад, лес или улица).\n"
        "Добавь кинематографичный свет (золотой час, туман, неон) и детали, создающие настроение."
    ),
    # сюда можно добавлять другие режимы
}


def build_prompt(mode: str, extra_text: Optional[str] = None) -> str:
    """
    Собирает финальный промт по ключу mode и доп. тексту.
    Используется в generate_image_from_url.
    """
    try:
        base_prompt = PROMPT_TEMPLATES[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим промта: {mode}") from exc

    if extra_text:
        extra_text = extra_text.strip()
        if extra_text:
            base_prompt = base_prompt.rstrip() + "\n\n" + extra_text

    return base_prompt


# --- НОВОЕ: описания режимов для генерации доп. текстов ---

EXTRA_PROMPT_MODE_DESCRIPTIONS: Dict[str, str] = {
    "base": (
        "Реалистичный режим. Натуральные материалы, спокойные современные цвета, "
        "правдоподобное освещение, дом выглядит правдоподобно и пригоден для реального строительства."
    ),
    "cinema": (
        "Кинематографичный режим. Атмосферное освещение, выразительные тени, настроение фильма, "
        "можно использовать более смелые сочетания света и цвета, но без превращения дома в фантастику."
    ),
    # при желании расширишь:
    # "fantasy": "...",
    # "night": "...",
}


def build_extra_prompts_prompt(mode: str) -> str:
    """
    Строит МЕТА-промт для Gemini, который должен сгенерировать 3 коротких доп. текста
    к основному промту генерации изображения, в зависимости от режима.
    """
    try:
        mode_description = EXTRA_PROMPT_MODE_DESCRIPTIONS[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим доп. промтов: {mode}") from exc

    # Логика похожа по духу на stylePrompt из HTML:
    meta_prompt = f"""Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.

Твоя задача — придумать ТРИ разных коротких текстовых дополнения, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.

РЕЖИМ: {mode}
Описание режима: {mode_description}

Требования к каждому дополнению:
- язык: русский;
- 1–2 предложения;
- дополняет и уточняет настроение, освещение, окружение, детали фасада;
- не противоречит режиму;
- все три варианта должны быть разными по формулировкам и идее.

ОЧЕНЬ ВАЖНО:
Верни ОДИН ВАЛИДНЫЙ JSON-МАССИВ СТРОК, БЕЗ какого-либо текста вне JSON.
Пример формата:
["Сделай мягкий вечерний свет и подчеркни тёплые оттенки дерева.",
 "Добавь лёгкий туман на заднем плане и мягко подсвети окна изнутри.",
 "Подчеркни контраст между тёплым светом дома и прохладным небом."]

Выведи ТОЛЬКО JSON-массив строк, без комментариев и пояснений.
"""
    return meta_prompt
