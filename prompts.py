from typing import Dict, Optional


class UnknownPromptModeError(Exception):
    """Бросаем, если mode неизвестен."""
    pass


PROMPT_TEMPLATES: Dict[str, str] = {
    "base": (
        """
          Обнови дизайн экстерьера этого дома.
          Не меняй архитектуру здания, геометрию стен и окон.
          Если пользователь явно указал детали или объекты, которые нужно изменить - меняй только их.
          Твоя задача — сделать профессиональный редизайн фасада.
          Используй современные материалы высокого качества.
          Сохрани реалистичность и естественное освещение.
          Фотореализм, 8k.
        """
    ),
    "cinema": (
        """
        Преврати это фото дома в кадр из высокобюджетного кинофильма.
		ВАЖНО: Дом остаётся частным жилым, не увеличивай масштаб, сохрани силуэт и основные формы здания.
		Полностью переработай стилистический дизайн фасада, но также ДОЛЖЕН изменить и окружение вокруг дома. 
		Создай атмосферный ландшафт: сад, лес, улицу, дорожки, водоёмы или элементы городской среды, 
        которые соответствуют выбранному кинематографическому стилю.
		Добавь кинематографичные детали: особое освещение (золотой час, туман, неон), архитектурный декор, 
        текстуры, которые делают сцену роскошной и атмосферной, как кадр голливудского фильма.
		Сцена должна выглядеть целостно: дом гармонично вписан в новое окружение, 
        создавая впечатление полноценного фильма, а не просто редизайна фасада.
        """
    ),
    "light": (
        """
        Трансформируй экстерьер дома, используя светлую и воздушную палитру.
        Не меняй архитектуру здания, геометрию стен и окон.
        Если пользователь явно указал детали или объекты, которые нужно изменить - меняй только их.
        Используй оттенки: белый, кремовый, жемчужный, светлое дерево, светлый камень.
        Дом должен выглядеть свежим, приветливым и легким.
        Окружение: солнечный день, яркое естественное освещение.
        Высокое качество, детальная проработка текстур.
        """
    ),
    "dark": (
        """
        Трансформируй экстерьер дома, используя темную и благородную палитру.
        Не меняй архитектуру здания, геометрию стен и окон.
        Если пользователь явно указал детали или объекты, которые нужно изменить - меняй только их.    
        Используй оттенки: антрацит, черный, графит, темное дерево, обожженный кирпич.    
        Дом должен выглядеть стильно, строго и дорого.    
        Освещение: контрастное, подчеркивающее текстуры.    
        Премиальный современный вид.
        """
    ),
}


def build_prompt(mode: str, extra_text: Optional[str] = None) -> str:
    """
    Собирает финальный промт по ключу mode и доп. тексту.
    Используется в generate_image_from_url.
    """
    try:
        base_prompt = PROMPT_TEMPLATES[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим промта: {mode}") from exc

    if extra_text:
        extra_text = extra_text.strip()
        if extra_text:
            base_prompt = base_prompt.rstrip() + "\n\n" + extra_text

    return base_prompt

response_json_example = """
СТРОГО верни JSON-массив такого вида:
[
{
    "message": "Краткое приветствие и описание настроения (на русском).",
    "palettes": [
     {
        "name": "Название стиля (короткое)",
        "description": "Стены: [Материал/Цвет]. Кровля: [Цвет]. Цоколь: [Материал/Цвет]. Детали: [Цвета]. Общее впечатление."
     },
     ...
    ]
},
]
"""

EXTRA_PROMPT_MODE_DESCRIPTIONS: Dict[str, str] = {
    "cinema": (
        f"""
            Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
            Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома. ВАЖНО изменить окружение и дом на изображении, исходя из выбранного фильма. ОБЯЗАТЕЛЬНО добавь на задний фон и в окружение изображения 1-2 атрибута, которые связаны с этим фильмом.
            
            Описание режима:
            Кинематографичный режим (Cinematic). Атмосфера художественного кадра, выразительного света, глубинного объёма, кинотекстур и настроений из известных фильмов.
            Подходят эстетики таких фильмов и сериалов: Побег из Шоушенка, Зелёная миля, Форрест Гамп, Список Шиндлера, Леон — профессионал, Начало, Интерстеллар, Бойцовский клуб, Престиж, Криминальное чтиво, Жизнь прекрасна, Матрица, Властелин колец, Паразиты, Волк с Уолл-стрит, Одержимость, Гладиатор, Дюна, Темный рыцарь, Темный рыцарь: Возрождение легенды, Одиннадцать друзей Оушена, Прочь, Социальная сеть, Начало, Амели, Холодное сердце, Коко, Король Лев, Рататуй, Титаник, Аватар, Планета обезьян: Война, Отступники, Сияние, Седьмой, Бесславные ублюдки, Ла-Ла Ленд, Лунный свет, Дюн, Звёздные войны: Эпизод IV, Звёздные войны: Эпизод V, Звёздные войны: Эпизод VI, Гарри Поттер и философский камень, Гарри Поттер и узник Азкабана, Человек-паук: Через вселенные, Скотт Пилигрим против всех, Игра в имитацию, Доктор Стрэндж, Шоу Трумана, Игра престолов, Во все тяжкие, Клан Сопрано, Друзья, Теория большого взрыва, Шерлок, Настоящий детектив, Фарго, Рик и Морти, Черное зеркало, Декстер, Доктор Хаус, Остаться в живых, Очень странные дела, Аватар: Легенда об Аанге, Гравити Фолз, Молодой Шелдон, Каратель, Брейкинг бэд: Эл Камино, Викинги, Воин, Люцифер, Сверхъестественное, Ходячие мертвецы, Сотня, Бесстыдники, Карточный домик, Во власти закона, Локи, Мандалорец, Ведьмак, Утреннее шоу, Странные дела 2, Секретные материалы, Френдс: Возвращение, Пациенты, Бруклин 9-9, Острые предметы, Обмани меня, Настоящий гений, Шанара, Песочный человек, Папаши, Сага о Форсайтах, Корона, Вражда, Мост, Хозяйка
            
            ТВОЯ ЗАДАЧА:
            Сгенерировать 6 вариантов JSON-объектов.
            
            Называй стили по названию фильмов.
            
            {response_json_example}
            
            ОГРАНИЧЕНИЯ:
            — Никакого текста вне JSON.
            — Никаких комментариев, пояснений, форматирования вне структуры.
            — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Cinematic.
            — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
    "light": (
        f"""
            Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
            Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
            Описание режима:
            Светлый режим (Light). Атмосфера чистоты, воздуха и мягкого естественного света.
            Подходят стили: Скандинавский, Прованс, Прибрежный, Скандинавский минимализм, Японско-скандинавский, Современная фермерская стилистика, Светлый деревенский, Лёгкий средиземноморский стиль, Эко-модерн.
            Характерные черты: светлые фасады, природные материалы, мягкие тени, пастельные тона, спокойное окружение, ощущение простора и свежести.
            
            Пиши и называй стили только на русском языке.
            
            ТВОЯ ЗАДАЧА:
            Сгенерировать 6 вариантов JSON-объектов.
            
            {response_json_example}
            
            ОГРАНИЧЕНИЯ:
            — Никакого текста вне JSON.
            — Никаких комментариев, пояснений, форматирования вне структуры.
            — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Light.
            — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
    "dark": (
        f"""
            Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
            Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
            
            Описание режима:
            Тёмный режим. Строгие, контрастные и архитектурно-графичные визуальные решения.
            Подходят стили: Барнхаус, Индастриал, Блэк модерн, Современный тёмный стиль, Тёмный японско-скандинавский стиль, Минималистичный брутальный стиль, Скандинавский нуар, Городской лофт.
            Характерные черты: насыщённые тёмные фасады, резкий или направленный свет, глубокие тени, минимализм в деталях, брутальность материалов, выразительные контрасты и графичность линий.
            
            Пиши и называй стили только на русском языке.
            
            ТВОЯ ЗАДАЧА:
            Сгенерировать 6 вариантов JSON-объектов.
            
            {response_json_example}
            
            ОГРАНИЧЕНИЯ:
            — Никакого текста вне JSON.
            — Никаких комментариев, пояснений, форматирования вне структуры.
            — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Dark.
            — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
    "base": (
        f"""
            Ты — AI дизайнер экстерьеров деревянных домов и генератор промтов.
            
            Твоя задача — придумать ШЕСТЬ разных коротких текстовых дополнений, которые можно ДОБАВИТЬ В КОНЕЦ основного промта для генерации изображения дома.
                        
            Описание режима:
            Подходят стили: Cовременная классика, Cовременный нейтральный стиль, Мягкий скандинавский стиль, Лаконичный европейский, Классический загородный, Тихий минимализм, Естественный деревянный экстерьер.
            Характерные черты: натуральные материалы, спокойные нейтральные оттенки, гармоничные пропорции, реалистичное освещение, умеренная детализация и акцент на естественный внешний вид дома без стилистических перегибов.
            
            Пиши и называй стили только на русском языке.
                    
            ТВОЯ ЗАДАЧА:
            Сгенерировать 6 вариантов JSON-объектов.
                    
            {response_json_example}
                    
            ОГРАНИЧЕНИЯ:
                — Никакого текста вне JSON.
                — Никаких комментариев, пояснений, форматирования вне структуры.
                — Каждый из 6 вариантов должен отличаться стилем и настроением, но соответствовать режима Base.
                — Архитектуру не менять: только цвета, материалы, настроение и образ.
        """
    ),
}


def build_extra_prompts_prompt(mode: str) -> str:
    """
    Строит МЕТА-промт для Gemini, который должен сгенерировать 3 коротких доп. текста
    к основному промту генерации изображения, в зависимости от режима.
    """
    try:
        meta_prompt = EXTRA_PROMPT_MODE_DESCRIPTIONS[mode]
    except KeyError as exc:
        raise UnknownPromptModeError(f"Неизвестный режим доп. промтов: {mode}") from exc
    return meta_prompt
